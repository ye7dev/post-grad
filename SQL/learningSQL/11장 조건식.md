# 11ì¥ ì¡°ê±´ì‹

- ìƒì„±ëœ ë°ì´í„°ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ë™ì‘í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ë¬¸ ì‘ì„± - case
- í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì¤‘ ì—¬ëŸ¬ ê²½ë¡œ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ
    - ì˜ˆ
        
        ```python
        select first_name, last_name,
        	case
        		when active = 1 then 'active' # customer tableì˜ active columnì´ ìˆìŒ 
        		else 'inactive'
          end activity_type # ì¹¼ëŸ¼ ì´ë¦„ 
        from customer;
        ```
        

### case í‘œí˜„ì‹

- ê²€ìƒ‰ëœ(searched) case í‘œí˜„ì‹
    
    ```sql
    CASE
    	WHEN C1 THEN E1 # C1: ì¡°ê±´, E1: ë°˜í™˜í•  í‘œí˜„ì‹ 
    	WHEN C2 THEN E2
    	...
    	WHEN CN THEN EN
    	[ELSE ED] # ì¡°ê±´ C1~CN ì¤‘ ì–´ëŠê²ƒë„ trueê°€ ì•„ë‹ ë•Œ case í‘œí˜„ì‹ì´ ë°˜í™˜í•˜ëŠ” ê¸°ë³¸ì‹
    END 
    ```
    
    - E1~ENì€ ëª¨ë‘ ë™ì¼í•œ íƒ€ì…ì´ì–´ì•¼ í•¨
    - when ì ˆì€ ìœ„ì—ì„œ ì•„ë˜ ìˆœì„œë¡œ í‰ê°€
    - ì¡°ê±´ ì¤‘ í•˜ë‚˜ê°€ trueë¡œ í‰ê°€ë˜ëŠ” ì¦‰ì‹œ í•´ë‹¹ í‘œí˜„ì‹ return, ë‚˜ë¨¸ì§€ëŠ” ë¬´ì‹œ
    - ì£¼ë¡œ select ì ˆ ì•ˆì—ì„œ ì‹¤í–‰
        - ì‹¤í–‰ ìˆœì„œë„ selectì— ë‹¹ë„í•´ì„œ ê° í–‰ì— ëŒ€í•´ ì‹¤í–‰ ë¨
    - ì˜ˆì‹œ-ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ì˜í™” ë¶„ë¥˜
        
        ```sql
        CASE
        when category.name in ('Children', 'Family', 'Sports', 'Animation')
        	then 'All Ages'
        when category.name = 'Horror'
        	then 'Adult'
        when category.name in ('Music', 'Games')
        	then 'Teens'
        else 'Other'
        END
        ```
        
    - ì˜ˆì‹œ-ë¬¸ìì—´ ë¿ë§Œ ì•„ë‹ˆë¼ ì„œë¸Œì¿¼ë¦¬ë¥¼ í¬í•¨í•´ì„œ ëª¨ë“  ìœ í˜•ì˜ í‘œí˜„ì‹ ë°˜í™˜ ê°€ëŠ¥
        
        ```sql
        select c.first_name, c.last_name,
        	case 
        		when active = 0 then 0
            else # í™œì„±í™”ëœ ê³ ê°ì— ëŒ€í•´ ì‹¤í–‰ 
        			(select count(*) 
                    from rental r 
                    where r.customer_id = c.customer_id)
        	end num_rentals
        from customer c;
        ```
        
- ë‹¨ìˆœ case í‘œí˜„ì‹
    - ê²€ìƒ‰ëœ case í‘œí˜„ì‹ì— ë¹„í•´ ëœ ìœ ì—°. ê¶Œì¥ì€ searched
        
        ```sql
        CASE V0 # ê°’ 
        	WHEN V1 THEN E1 # V1: V0ê³¼ ë¹„êµí•  ê°’ 
        	WHEN V2 THEN E2
        	...
        	WHEN VN THEN EN
        	[ELSE ED] # ì¡°ê±´ V1~VN ì¤‘ ì–´ëŠê²ƒë„ trueê°€ ì•„ë‹ ë•Œ case í‘œí˜„ì‹ì´ ë°˜í™˜í•˜ëŠ” ê¸°ë³¸ì‹
        END 
        ```
        
    - ì˜ˆì‹œ-ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ì˜í™” ë¶„ë¥˜(2)
        
        ```sql
        CASE category.name
        	when 'Children' then 'All Ages'
        	when 'Family' then 'All Ages'
        	when 'Sports' then 'All Ages'
        	when 'Animation' then 'All Ages'
        	when 'Horror' then 'Adult'
        	when 'Music' then 'Teens'
        	when 'Games' then 'Teens'
        	else 'Other'
        END
        ```
        

### case í‘œí˜„ì‹ì˜ ì˜ˆ

- ê²°ê³¼ì…‹ ë³€í™˜
    - ê²°ê³¼ì…‹ì— ê°’ ë‹¹ í•˜ë‚˜ì˜ í–‰ â†’ ê°’ ë‹¹ í•˜ë‚˜ì˜ ì—´ì´ ìˆëŠ” ë‹¨ì¼ í–‰ì„ ë§Œë“œëŠ” ë°©ë²•
    - ì˜ˆ: 2005ë…„ 5~7ì›” ì›”ë³„ ì˜í™” ëŒ€ì—¬ íšŸìˆ˜
        - ê¸°ì¡´: ê°’ ë‹¹ í•˜ë‚˜ì˜ í–‰ (ì›”ë³„ë¡œ í–‰ 1ê°œì”© â†’ ì´ 3ê°œ í–‰)
            
            ```sql
            select monthname(rental_date) rental_month, count(*) num_rentals 
            from rental 
            where rental_date between '2005-05-01' and '2005-08-01' 
            group by monthname(rental_date)
            
            ```
            
        - case ì‚¬ìš©: ì›”ë³„ë¡œ ì—´ 1ê°œì”© â†’ ì´ 3ê°œ ì—´, 1ê°œ í–‰
            
            ```sql
            select
            	sum(case when monthname(rental_date) = 'May' then 1 else 0 end) May_rentals,
              sum(case when monthname(rental_date) = 'June' then 1 else 0 end) June_rentals,
              sum(case when monthname(rental_date) = 'July' then 1 else 0 end) July_rentals
            from rental r 
            where rental_date between '2005-05-01' and '2005-08-01';
            ```
            
- ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    - ë‘ entity ê°„ì— ê´€ê³„ê°€ ìˆëŠ”ì§€ ì—¬ë¶€ í™•ì¸
    - ì˜ˆ-ì‹¤ì œ ì˜í™” ìˆ˜ì™€ëŠ” ê´€ê³„ ì—†ì´ ë°°ìš°ê°€ G ë“±ê¸‰ ì˜í™”ì— ì¶œì—°í–ˆëŠ”ì§€ ì—¬ë¶€(yes or no) í™•ì¸
        
        ```sql
        select a.first_name, a.last_name,
        	case
            when exists (select 1 
        				 from film_actor fa 
        					inner join film f 
        					on fa.film_id = f.film_id
        				 where fa.actor_id = a.actor_id and f.rating = 'G') then 'Y'
        	else 'N'
            end g_actor, 
            case 
            when exists (select 1
        				 from film_actor fa
        					inner join film f
                            on fa.film_id = f.film_id
        				 where fa.actor_id = a.actor_id and f.rating = 'PG') then 'Y'
        	else 'N'
            end pg_actor,
            case when exists (select 1 
        					  from film_actor fa
        						inner join film f
                                on fa.film_id = f.film_id
        					  where fa.actor_id = a.actor_id and f.rating = 'NC-17') then 'Y'
        	else 'N'
            end nc_actor
        from actor a 
        where a.last_name like 'S%' or a.first_name like 'S%';
        ```
        
        1. actor tableì„ ê°€ì ¸ì˜¨ë‹¤
        2. where ì ˆì— ìˆëŠ” ì¡°ê±´ìœ¼ë¡œ í–‰ í•„í„°ë§ â†’ ìµœì¢… í›„ë³´ í–‰ë§Œ ë‚¨ìŒ 
        3. actor tableì˜ ìµœì¢… í›„ë³´ í–‰ í•˜ë‚˜ í•˜ë‚˜ì— ëŒ€í•´ 
            1. first, last ì´ë¦„ ê°€ì ¸ì˜¨ë‹¤
            2. caseë¬¸ ì§„ì…
                1. from ì ˆì— ìˆëŠ” film_actor í…Œì´ë¸”ì„ ë“¤ê³  ì˜¨ë‹¤ 
                2. film tableì™€ film_id ê¸°ì¤€ìœ¼ë¡œ ì¡°ì¸ ìˆ˜í–‰í•œë‹¤ 
                3. ì¡°ì¸ëœ tableì—ì„œ fa.actor_idê°€ í˜„ì¬ í›„ë³´ í–‰ actor_idì™€ ê°™ìœ¼ë©´ì„œ ratingì´ â€˜PGâ€™ì— í•´ë‹¹ë˜ëŠ”ì§€ ì²´í¬í•œë‹¤ 
                    - ì‚¬ì‹¤ actor_idê°€ ì¼ì¹˜í•˜ëŠ” í–‰ì€ ì—¬ëŸ¬ ê°œê°€ ìˆì„ ê²ƒ
                    - ê·¸ ì¤‘ì—ì„œ PG ë“±ê¸‰ì¸ ì˜í™”ëŠ” ë” ì ì„ ê²ƒ
                4. Trueë¥¼ ë°˜í™˜í•˜ë©´ â€˜Yâ€™ê°’ì„, Falseë¥¼ ë°˜í™˜í•˜ë©´ â€˜Nâ€™ ê°’ì„ return í•œë‹¤ 
            3. ì´ ê°’ì„ pg_actorë¼ëŠ” column ê°’ìœ¼ë¡œ ë‘”ë‹¤ 
            4. ê°™ì€ ê³¼ì •ì„ ì•„ë˜ì˜ ë‘ ì¡°ê±´ì‹ì— ëŒ€í•´ì„œë„ ì‹¤í–‰ 
            
            â†’ ìµœì¢…ì ìœ¼ë¡œ í›„ë³´ í–‰ í•˜ë‚˜ì— ëŒ€í•´ first,last ì´ë¦„, g column ê°’, pg column ê°’, nc-17 column ê°’ ì´ 5ê°œë¥¼ ê°–ê²Œ ëœë‹¤ 
            
        - ê·¼ë° í›„ë³´ í–‰ í•˜ë‚˜í•˜ë‚˜ì— ëŒ€í•´ í…Œì´ë¸” ì¡°ì¸ì„ 3ë²ˆì”© ëª¨ë‘ ì‹¤í–‰í•´ì•¼ í•˜ë‹ˆ ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆê² ë‹¤
            - ì°¨ë¼ë¦¬ ì¡°ì¸ì„ í•œë²ˆì— ë‹¤ í•´ ë†“ê³  caseë¥¼ ì‹¤í–‰í•˜ëŠ”ê²Œâ€¦.
- ì–¼ë§ˆë‚˜ ë§ì€ í–‰ì´ í•´ë‹¹ë˜ëŠ”ì§€
    - ì˜í™” ì¬ê³  ì‚¬ë³¸ ìˆ˜ ê³„ì‚° ë’¤ ê°œìˆ˜ì— ë”°ë¼ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
        
        ```sql
        select f.title,
        	case(select count(*) 
        		from inventory i
        		where i.film_id = f.film_id) /* simple case expression */
        		when 0 then 'Out Of Stock'
        		when 1 then 'Scarce'
        		when 2 then 'Scarce'
                when 3 then 'Available'
                when 4 then 'Available'
                else 'Common'
        	end film_availability /* column name */
        from film f ;
        ```
        
- 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ì˜¤ë¥˜
    - select 100 / 0 í•˜ë©´ null return
    - case ë¬¸ìœ¼ë¡œ ë¶„ëª¨ì— ì¡°ê±´ì‹ ì ìš©í•˜ê¸°
    
    ```sql
    select c.first_name, c.last_name,
    	sum(p.amount) tot_payment_amt,
        count(p.amount) num_payments,
        /* column with division */
        sum(p.amount) / 
    		/* condition on denominator */
    		CASE WHEN count(p.amount) = 0 then 1 
    			ELSE count(p.amount) 
    		END avg_payment /* col name */
    from customer c 
    	left outer join payment p
        on c.customer_id = p.customer_id
    group by c.first_name, c.last_name;
    ```
    
- ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸
    - 90ì¼ ë™ì•ˆ ì˜í™”ë¥¼ ëŒ€ì—¬í•˜ì§€ ì•Šì€ ëª¨ë“  ê³ ê°ì˜ active ì—´ì„ 0ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ì‘ì—…ì„ ë§¤ì£¼ ì‹¤í–‰
        
        ```sql
        update customer
        set active = 
        	case
        		when 90 <= (select datediff(now(), max(rental_date))
        					from rental r 
                            where r.customer_id = customer.customer_id)
        				then 0
        			else 1
        		end 
        	where active = 1;
        ```
        
- null ê°’ ì²˜ë¦¬
    - null ê°’ì„ ë‹¤ë¥¸ ë¬¸ìì—´ë¡œ ëŒ€ì²´
        
        ```sql
        select c.first_name, c.last_name,
        	case 
        		when a.address is null then 'unknown'
        		else a.address
        	end address,
            case 
        		when ct.city is null then 'unknown'
        		else ct.city
        	end city,
            case 
        		when cn.country is null then 'unknown'
        		else cn.country
        	end country
        from customer c 
        	left outer join address a 
        		on c.address_id = a.address_id
        	left outer join city ct
        		on a.city_id = ct.city_id
        	left outer join country cn
        		on ct.country_id = cn.country_id;  
                
                
        ```
        
- ì‹¤ìŠµ
    - ë‹¨ìˆœ case í‘œí˜„ì‹ â†’ ê²€ìƒ‰ëœ case í‘œí˜„ì‹
        
        ```sql
        select name,
        	case when name in ('English', 'Italian', 'French', 'German') then 'latin1'
        		 when name in ('Japanese', 'Mandarin') then 'utf8'
                 else 'unknown'
        	end character_set
        from language;
        ```
        
        ++ ë§ì•˜ìŒ. ë‹¤ë§Œ ê°€ì§€ëŸ°í•œ í‘œê¸°ë¥¼ ìœ„í•´ ë“¤ì—¬ì“°ê¸° ì¡°ì •í•˜ë©´ 
        
        - caseë‘ endë‘ ë‚˜ë€íˆ
        - í•˜ìœ„ë¡œ when ë” í•˜ìœ„ë¡œ then
        - elseëŠ” whenê³¼ ê°™ì€ ë“¤ì—¬ì“°ê¸°
        
        ```sql
        select name,
        	case 
        		when name in ('English', 'Italian', 'French', 'German') 
        			then 'latin1'
        		when name in ('Japanese', 'Mandarin') 
        			then 'utf8'
            else 'unknown'
        	end character_set
        from language;
        ```
        
    - 5ê°œì˜ columnì´ ìˆëŠ” í•˜ë‚˜ì˜ í–‰ ë§Œë“¤ê¸°
        
        ```sql
        select sum(case when rating = 'PG' then 1 else 0 end) 'PG',
        		   sum(case when rating = 'G' then 1 else 0 end) 'G',
               sum(case when rating = 'NC-17' then 1 else 0 end) 'NC-17',
               sum(case when rating = 'PG-13' then 1 else 0 end) 'PG-13',
               sum(case when rating = 'R' then 1 else 0 end) 'R'
        from film;
        ```
        
        ++ ì˜í–ˆë‹¤. case when 1 0 í•˜ê³  sum ë•Œë¦¬ë©´ ëœë‹¤ëŠ” ì  ìŠì§€ ë§ê¸” - ğŸ’«