# 11장 조건식

- 생성된 데이터에 따라 다르게 동작할 수 있는 명령문 작성 - case
- 프로그램 실행 중 여러 경로 중 하나를 선택
    - 예
        
        ```python
        select first_name, last_name,
        	case
        		when active = 1 then 'active' # customer table의 active column이 있음 
        		else 'inactive'
          end activity_type # 칼럼 이름 
        from customer;
        ```
        

### case 표현식

- 검색된(searched) case 표현식
    
    ```sql
    CASE
    	WHEN C1 THEN E1 # C1: 조건, E1: 반환할 표현식 
    	WHEN C2 THEN E2
    	...
    	WHEN CN THEN EN
    	[ELSE ED] # 조건 C1~CN 중 어느것도 true가 아닐 때 case 표현식이 반환하는 기본식
    END 
    ```
    
    - E1~EN은 모두 동일한 타입이어야 함
    - when 절은 위에서 아래 순서로 평가
    - 조건 중 하나가 true로 평가되는 즉시 해당 표현식 return, 나머지는 무시
    - 주로 select 절 안에서 실행
        - 실행 순서도 select에 당도해서 각 행에 대해 실행 됨
    - 예시-카테고리에 따라 영화 분류
        
        ```sql
        CASE
        when category.name in ('Children', 'Family', 'Sports', 'Animation')
        	then 'All Ages'
        when category.name = 'Horror'
        	then 'Adult'
        when category.name in ('Music', 'Games')
        	then 'Teens'
        else 'Other'
        END
        ```
        
    - 예시-문자열 뿐만 아니라 서브쿼리를 포함해서 모든 유형의 표현식 반환 가능
        
        ```sql
        select c.first_name, c.last_name,
        	case 
        		when active = 0 then 0
            else # 활성화된 고객에 대해 실행 
        			(select count(*) 
                    from rental r 
                    where r.customer_id = c.customer_id)
        	end num_rentals
        from customer c;
        ```
        
- 단순 case 표현식
    - 검색된 case 표현식에 비해 덜 유연. 권장은 searched
        
        ```sql
        CASE V0 # 값 
        	WHEN V1 THEN E1 # V1: V0과 비교할 값 
        	WHEN V2 THEN E2
        	...
        	WHEN VN THEN EN
        	[ELSE ED] # 조건 V1~VN 중 어느것도 true가 아닐 때 case 표현식이 반환하는 기본식
        END 
        ```
        
    - 예시-카테고리에 따라 영화 분류(2)
        
        ```sql
        CASE category.name
        	when 'Children' then 'All Ages'
        	when 'Family' then 'All Ages'
        	when 'Sports' then 'All Ages'
        	when 'Animation' then 'All Ages'
        	when 'Horror' then 'Adult'
        	when 'Music' then 'Teens'
        	when 'Games' then 'Teens'
        	else 'Other'
        END
        ```
        

### case 표현식의 예

- 결과셋 변환
    - 결과셋에 값 당 하나의 행 → 값 당 하나의 열이 있는 단일 행을 만드는 방법
    - 예: 2005년 5~7월 월별 영화 대여 횟수
        - 기존: 값 당 하나의 행 (월별로 행 1개씩 → 총 3개 행)
            
            ```sql
            select monthname(rental_date) rental_month, count(*) num_rentals 
            from rental 
            where rental_date between '2005-05-01' and '2005-08-01' 
            group by monthname(rental_date)
            
            ```
            
        - case 사용: 월별로 열 1개씩 → 총 3개 열, 1개 행
            
            ```sql
            select
            	sum(case when monthname(rental_date) = 'May' then 1 else 0 end) May_rentals,
              sum(case when monthname(rental_date) = 'June' then 1 else 0 end) June_rentals,
              sum(case when monthname(rental_date) = 'July' then 1 else 0 end) July_rentals
            from rental r 
            where rental_date between '2005-05-01' and '2005-08-01';
            ```
            
- 존재 여부 확인
    - 두 entity 간에 관계가 있는지 여부 확인
    - 예-실제 영화 수와는 관계 없이 배우가 G 등급 영화에 출연했는지 여부(yes or no) 확인
        
        ```sql
        select a.first_name, a.last_name,
        	case
            when exists (select 1 
        				 from film_actor fa 
        					inner join film f 
        					on fa.film_id = f.film_id
        				 where fa.actor_id = a.actor_id and f.rating = 'G') then 'Y'
        	else 'N'
            end g_actor, 
            case 
            when exists (select 1
        				 from film_actor fa
        					inner join film f
                            on fa.film_id = f.film_id
        				 where fa.actor_id = a.actor_id and f.rating = 'PG') then 'Y'
        	else 'N'
            end pg_actor,
            case when exists (select 1 
        					  from film_actor fa
        						inner join film f
                                on fa.film_id = f.film_id
        					  where fa.actor_id = a.actor_id and f.rating = 'NC-17') then 'Y'
        	else 'N'
            end nc_actor
        from actor a 
        where a.last_name like 'S%' or a.first_name like 'S%';
        ```
        
        1. actor table을 가져온다
        2. where 절에 있는 조건으로 행 필터링 → 최종 후보 행만 남음 
        3. actor table의 최종 후보 행 하나 하나에 대해 
            1. first, last 이름 가져온다
            2. case문 진입
                1. from 절에 있는 film_actor 테이블을 들고 온다 
                2. film table와 film_id 기준으로 조인 수행한다 
                3. 조인된 table에서 fa.actor_id가 현재 후보 행 actor_id와 같으면서 rating이 ‘PG’에 해당되는지 체크한다 
                    - 사실 actor_id가 일치하는 행은 여러 개가 있을 것
                    - 그 중에서 PG 등급인 영화는 더 적을 것
                4. True를 반환하면 ‘Y’값을, False를 반환하면 ‘N’ 값을 return 한다 
            3. 이 값을 pg_actor라는 column 값으로 둔다 
            4. 같은 과정을 아래의 두 조건식에 대해서도 실행 
            
            → 최종적으로 후보 행 하나에 대해 first,last 이름, g column 값, pg column 값, nc-17 column 값 총 5개를 갖게 된다 
            
        - 근데 후보 행 하나하나에 대해 테이블 조인을 3번씩 모두 실행해야 하니 비효율적일 수 있겠다
            - 차라리 조인을 한번에 다 해 놓고 case를 실행하는게….
- 얼마나 많은 행이 해당되는지
    - 영화 재고 사본 수 계산 뒤 개수에 따라 카테고리 분류
        
        ```sql
        select f.title,
        	case(select count(*) 
        		from inventory i
        		where i.film_id = f.film_id) /* simple case expression */
        		when 0 then 'Out Of Stock'
        		when 1 then 'Scarce'
        		when 2 then 'Scarce'
                when 3 then 'Available'
                when 4 then 'Available'
                else 'Common'
        	end film_availability /* column name */
        from film f ;
        ```
        
- 0으로 나누기 오류
    - select 100 / 0 하면 null return
    - case 문으로 분모에 조건식 적용하기
    
    ```sql
    select c.first_name, c.last_name,
    	sum(p.amount) tot_payment_amt,
        count(p.amount) num_payments,
        /* column with division */
        sum(p.amount) / 
    		/* condition on denominator */
    		CASE WHEN count(p.amount) = 0 then 1 
    			ELSE count(p.amount) 
    		END avg_payment /* col name */
    from customer c 
    	left outer join payment p
        on c.customer_id = p.customer_id
    group by c.first_name, c.last_name;
    ```
    
- 조건부 업데이트
    - 90일 동안 영화를 대여하지 않은 모든 고객의 active 열을 0으로 설정하는 작업을 매주 실행
        
        ```sql
        update customer
        set active = 
        	case
        		when 90 <= (select datediff(now(), max(rental_date))
        					from rental r 
                            where r.customer_id = customer.customer_id)
        				then 0
        			else 1
        		end 
        	where active = 1;
        ```
        
- null 값 처리
    - null 값을 다른 문자열로 대체
        
        ```sql
        select c.first_name, c.last_name,
        	case 
        		when a.address is null then 'unknown'
        		else a.address
        	end address,
            case 
        		when ct.city is null then 'unknown'
        		else ct.city
        	end city,
            case 
        		when cn.country is null then 'unknown'
        		else cn.country
        	end country
        from customer c 
        	left outer join address a 
        		on c.address_id = a.address_id
        	left outer join city ct
        		on a.city_id = ct.city_id
        	left outer join country cn
        		on ct.country_id = cn.country_id;  
                
                
        ```
        
- 실습
    - 단순 case 표현식 → 검색된 case 표현식
        
        ```sql
        select name,
        	case when name in ('English', 'Italian', 'French', 'German') then 'latin1'
        		 when name in ('Japanese', 'Mandarin') then 'utf8'
                 else 'unknown'
        	end character_set
        from language;
        ```
        
        ++ 맞았음. 다만 가지런한 표기를 위해 들여쓰기 조정하면 
        
        - case랑 end랑 나란히
        - 하위로 when 더 하위로 then
        - else는 when과 같은 들여쓰기
        
        ```sql
        select name,
        	case 
        		when name in ('English', 'Italian', 'French', 'German') 
        			then 'latin1'
        		when name in ('Japanese', 'Mandarin') 
        			then 'utf8'
            else 'unknown'
        	end character_set
        from language;
        ```
        
    - 5개의 column이 있는 하나의 행 만들기
        
        ```sql
        select sum(case when rating = 'PG' then 1 else 0 end) 'PG',
        		   sum(case when rating = 'G' then 1 else 0 end) 'G',
               sum(case when rating = 'NC-17' then 1 else 0 end) 'NC-17',
               sum(case when rating = 'PG-13' then 1 else 0 end) 'PG-13',
               sum(case when rating = 'R' then 1 else 0 end) 'R'
        from film;
        ```
        
        ++ 잘했다. case when 1 0 하고 sum 때리면 된다는 점 잊지 말긔 - 💫