# 3장 쿼리 입문

- 쿼리 절
    
    
    | 이름 | 목적 |
    | --- | --- |
    | select | 쿼리 결과에 포함할 열을 결정 |
    | from | 데이터를 검색할 테이블과, 테이블을 조인하는 방법 식별  |
    | where | 불필요한 데이터 걸러내기  |
    | group by  | 공통 열 값을 기준으로 행을 그룹화  |
    | having | 불필요한 그룹을 걸러냄 |
    | order by  | 하나 이상의 열을 기준으로 최종 결과의 행을 정렬  |
- select에 추가할 수 있는 항목
    - 숫자, 문자열과 같은 Literal
    - transaction.amount * -1 과 같은 표현식
    - ROUND(transaction.amount, 2)와 같은 내장 함수 호출
    - 사용자 정의 함수 호출
    
    ```sql
    SELECT language_id, 'COMMON' language_usage, language_id * 3.1415927 lang_pi_value, upper(name) language_name
    FROM language;
    ```
    
    - distinct는 select 뒤다!
- from 절
    - permanent table: create table로 생성
    - derived(파생) table:  하위 쿼리에서 반환하고 메모리에 보관된 행
    - temporary table: 메모리에 저장된 휘발성 데이터
    - virtual table: create view문으로 생성
- 파생 테이블
    - subquery: 다른 쿼리에 포함된 쿼리
        - select문 아니고 from 절에 포함된 서브 쿼리는 from절에 명시된 다른 테이블과 상호작용할 수 있는 파생 테이블을 생성하는 역할
    - 파생 테이블 예시
        
        ```sql
        SELECT concat(cust.last_name, ', ', cust.first_name) full_name
        FROM (SELECT first_name, last_name, email
        	FROM customer
            WHERE first_name = 'JESSIE')
            cust;
        ```
        
        - from 절 내의 subquery → 총 3개 열 반환 → 전체 쿼리는 이 중 두 개의 열 참조
        - 서브 쿼리는 별칭 ‘cust’를 통해 참조 → 쿼리 기간 동안 메모리에 보관된 후 삭제
- 임시 테이블
    
    ```sql
    CREATE TEMPORARY TABLE actors_j  
    (actor_id smallint(5),  
    first_name varchar(45),     
    last_name varchar(45))
    
    INSERT INTO actors_j 
    	# 아래의 조건 만족하는 7개의 행이 가상 테이블에 추가됨 
    	SELECT actor_id, first_name, last_name 
    	FROM actor 
    	WHERE last_name LIKE 'J%'
    
    SELECT * FROM actors_j # 여기서 호출 가능 
    # 일시적으로 메모리에 저장되며 세션이 종료되면 사라짐 
    ```
    
- 가상 테이블
    - 뷰: 데이터 딕셔너리에 저장된 쿼리. 테이블 처럼 동작하지만 데이터가 존재하는 것은 아님
    - 뷰에 대해 쿼리를 실행하면 쿼리가 뷰 정의와 합쳐져 실행할 최종 쿼리 생성
    
    ```sql
    CREATE VIEW cust_vw AS
    	SELECT customer_id, first_name, last_name, active
        FROM customer; 
    ```
    
    - 여기서 AS는 alias 용이 아님
        - **`AS`**는 여기서 "as specified by the following SELECT statement" 즉, "다음 SELECT 문에 의해 지정된 대로"라는 의미로 해석할 수 있습니다. 별칭을 위한 **`AS`**와는 다르게, 뷰 생성에서의 **`AS`**는 필수적인 구문 요소로, 뷰의 이름과 SELECT 문 사이에 위치하여, "이 이름을 가진 뷰를 다음 SELECT 문의 결과로 정의한다"는 것을 명시합니다.
        - 뷰의 이름과 SELECT 문 사이에 넣는 단어임
- 테이블 연결
    
    ```sql
    select customer.first_name, customer.last_name, time(rental.rental_date) rental_time 
    from customer   
    	inner join rental     
    	on customer.customer_id = rental.customer_id 
    where date(rental.rental_date) = '2005-06-14'
    ```
    
- 테이블 별칭 정의
    - 단일 쿼리에서 여러 테이블 조인하는 경우, select, where, group by, having, order by 등에서 열을 참조할 때 참조 테이블을 식별할 방법이 필요
    - from 절 외부에서 테이블을 참조할 때는
        1. employee.emp_id와 같이 전체 테이블 이름 사용
        2. 각 테이블의 별칭을 할당하고 쿼리 전체에서 해당 별칭을 사용 
    
    ```sql
    # AS는 생략된 상태 
    select c.first_name, c.last_name, time(r.rental_date) rental_time
    from customer c
      inner join rental r 
      on c.customer_id = r.customer_id
    where date(r.rental_date) = '2005-06-14'
    ```
    
- where 조건 여러개일 때는 괄호로 묶어야
    
    ```sql
    select title, rating, rental_duration
    from film
    where (rating = 'G' and rental_duration >= 7) or (rating = 'PG-13' and rental_duration < 4);
    ```
    
- group by
    
    ```sql
    select c.first_name, c.last_name, count(*)
    from customer c 
    	inner join rental r 
        on c.customer_id = r.customer_id
    group by c.first_name, c.last_name # 고객별로 대여 내역 그룹화 
    having count(*) >= 40; # 전체 대여 횟수 40 넘는 고객만 return 
    ```
    
- 실습
    - 1
        
        ```sql
        select actor_id, first_name, last_name
        from actor
        order by last_name, first_name
        ```
        
    - 2
        
        ```sql
        select actor_id, first_name, last_name
        from actor
        where last_name = 'WILLIAMS' or last_name = 'DAVIS';
        ```
        
    - 3
        
        ```sql
        select distinct r.customer_id
        from rental r 
        where date(r.rental_date) = '2005-07-05';
        ```
        
    - 4
        
        r, r.customer_id, return_date, desc