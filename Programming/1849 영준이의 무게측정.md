# 1849. ì˜ì¤€ì´ì˜ ë¬´ê²Œì¸¡ì •

Created time: April 26, 2024 10:45 AM
Last edited time: April 29, 2024 3:34 PM

- ë¬¸ì œ ì´í•´
    - 4 â†’ 1ë¡œ ì—°ê²°ì´ ë˜ì–´ ìˆëŠëƒâ€¦
    - 3, 4
    - 2, 3
    - 1, 2
    - ë©´ ì—°ê²°ì´ ë˜ì–´ ìˆìŒ
- Lessons
    1. ì…ë ¥ í‚¤ëŠ” ë¬¸ì, ì‚¬ì „ ì•ˆì—ì„œ ì´ˆê¸°í™”í•œ í‚¤ ê°’ì€ ì •ìˆ˜ë¼ì„œ í˜• ë³€í™˜ ì•ˆí•˜ë©´ keyError ë°œìƒ
    2. í° ìª½-ì‘ì€ ìª½ ì°¨ì´ë§Œ ì‚¬ì „ì— ê¸°ë¡í•˜ì§€ ë§ê³ , ë°˜ëŒ€ë¡œë„ - ì‘ì€ ìª½-í°ìª½ = -ì£¼ì–´ì§„ ì°¨ - ë¡œ ê¸°ë¡í•´ë‘¬ì•¼ í•¨ 
    3. BFSëŠ” ì‹œê°„ ì´ˆê³¼ ë‚œë‹¤ 
    4. Union-Findë¥¼ ë³€í˜•í•´ì„œ ì‚¬ìš©í•œë‹¤
        - weight : ìê¸°ê°€ ì†í•œ ê·¸ë£¹ì˜ ìµœìƒìœ„ë¦¬ë”ë¡œë¶€í„° ìê¸° ìì‹ ì˜ ë¬´ê²Œ ì°¨
            - íŠ¸ë¦¬ì˜ ê· í˜•ì„ ìœ„í•´ ë‚˜ë³´ë‹¤ ë¬´ê²ŒëŠ” ë” ì‘ì§€ë§Œ rankê°€ ë†’ì€ ì›ì†Œ ë°‘ìœ¼ë¡œ ë³‘í•©ë  ìˆ˜ë„ ìˆë‹¤
            - ì´ ê²½ìš° inputìœ¼ë¡œ ë“¤ì–´ì˜¨ b-a ë¬´ê²Œ ì°¨ wëŠ” ìŒìˆ˜ê°€ ë˜ì–´ì„œ bì™€, aê°€ ì†í•œ ê·¸ë£¹ì˜ ìµœìƒìœ„ë¦¬ë” ì‚¬ì´ì˜ ê°€ì¤‘ì¹˜ë¥¼ ê³„ì‚°í•˜ëŠ” ë° ì‚¬ìš©ëœë‹¤
    5. inputì—ì„œ a, b ìì²´ì˜ ê°’ì€ aê°€ ë” í´ ìˆ˜ë„ ìˆë‹¤ â† ì–˜ë„¤ëŠ” index. ê·¸ëŸ¬ë‚˜ bì˜ ë¬´ê²ŒëŠ” ëŠ˜ aì˜ ë¬´ê²Œë³´ë‹¤ í¬ë‹¤ 
- Trial
    - BFS (5/18 ì‹œê°„ì œí•œ ì´ˆê³¼)
        
        ```sql
        from collections import deque
        def get_diff(idx_a, idx_b, info):
            # base case
            if idx_a in info[idx_b]:
                return info[idx_b][idx_a]
        
            if len(info[idx_b]) == 0:
                return 'UNKNOWN'
        
            # iterative case
            visited = [False] * (N+1)
            for key in info[idx_b]:
                visited[key] = True
            dq = deque(info[idx_b].items())
            while dq:
                cur_node, cur_diff = dq.popleft()
                if cur_node == idx_a:
                    return cur_diff
                for next_node in info[cur_node]:
                    if visited[next_node]:
                        continue
                    visited[next_node] = True
                    next_diff = info[cur_node][next_node] + cur_diff
                    dq.append((next_node, next_diff))
            return 'UNKNOWN'
        
        T = int(input())
        for t in range(1, T+1):
            N, M = map(int, input().split())
            notes = {i:{} for i in range(1, N+1)}
            ans = []
            for _ in range(M):
                data = list(input().split())
                if len(data) == 4:
                    a, b, w = map(int, data[1:])
                    notes[b][a] = w
                    notes[a][b] = -w
                else:
                    a, b = map(int, data[1:])
                    ans.append(str(get_diff(a, b, notes)))
            print(f'#{t} {" ".join(ans)}')
        ```
        
- ë‚¨ì˜ ì½”ë“œ ì´í•´í•˜ê¸°
    - virgin union
        - ë¶€ëª¨ê°€ ì—†ìœ¼ë©´ - union ëœì  í•œë²ˆë„ ì—†ìœ¼ë©´- ìê¸° ìì‹ ìœ¼ë¡œ ë‚˜ì˜´
        - ë¶€ëª¨ê°€ ê°™ìœ¼ë©´ ì´ë¯¸ union ëœ ìƒíƒœë¼ pass
        - ì²˜ìŒì—ëŠ” weight ê¸°ë¡ ì—†ìœ¼ë‹ˆê¹Œ 0
        - ê°ìì˜ rankë„ ë‹¤ 0ì´ë¼ ë™ì¼ - ì¡°ê±´ë¬¸ ë¶€ë¶„ ê±´ë„ˆëœ€
        - pa =a, pb = bì¸ ìƒí™©ì—ì„œ ëŠ˜ bì˜ ë¬´ê²Œê°€ ë” ë¬´ê²ë‹¤ê³  í–ˆìœ¼ë¯€ë¡œ pb(b)ë¡œ ë³‘í•©
            - pa=a ìª½ ë¬´ê²Œì— wë¥¼ ë”í•´ì¤€ë‹¤
            - rankê°€ ê°™ì€ ìƒí™©ì´ê¸° ë•Œë¬¸ì— ë³‘í•©í•œ pb(b) ìª½ì˜ rankë¥¼ 1 ë”í•´ì¤€ë‹¤
    - experienced union
        - ! 1 2 100
            - weight[1] = 100
            - parent[1] = 2
            - rank[2] = 1
            
            â†’ ? 2 3 â†’ unknown 
            
        - ! 2 3 100
            - find(2) = parent[2] = 0 â†’ return 2
            - find(3) = parent[3] = 0 â†’ return 3
            - diffëŠ” ì•„ì§ ë‘˜ë‹¤ ë¬´ê²Œ ì—†ì–´ì„œ 0
            - rank ë¹„êµ: rank[2] = 1 > rank[3] = 0
                
                â†’ pa â†” pb â†’ pa = 3, pb = 2 
                
                w = -100 
                
                diff = 0 
                
            - weight[pa] = w + diff
                - weight[3] = -100
            - parent[pa] = parent[3] = pb = 2
            
            â†’ ? 2 3 
            
            - find(2)
                - parent[2]  = 0 â†’ return 2
            - find(3)
                - parent[3] = 2
            
            â†’ ë‘˜ì˜ ë¶€ëª¨ê°€ ê°™ìŒ â†’ weight[a] - weight[b] = 0 - (-100) = 100 
            
        - ? 1 3
            - find(1)
                - 2 = parent[1]
            - find(3)
                - 2  = parent[3]
            - ë‘˜ì˜ ë¶€ëª¨ê°€ ê°™ìŒ â†’ weight[a] - weight[b] = 100 - (-100) = 200
        - ! 4 3 150
            - find(4)
                - parent[4] = 0 â†’ return 4
            - find(3)
                - parent[3] = 2
            - diff = -100 - 0 = -100
            - rankì˜ ê²½ìš°
                - rank[4] = 0 < rank[2] = 1 â†’ ì¡°ê±´ë¬¸ skip
            - weight[4] = 150 - 100 = 50
                - 3ì—ì„œ -100ì„ ë”í•´ì•¼ 2ì˜ ë¬´ê²Œê°€ ë˜ê³ 
                - 4ì—ì„œ 150ì„ ë”í•´ì•¼ 3ì˜ ë¬´ê²Œê°€ ë¨
                
                â†’ 4ì—ì„œ 150ì„ ë”í•´ì„œ 3ì˜ ë¬´ê²Œê°€ ëœ ë‹¤ìŒì— ë‹¤ì‹œ -100ì„ í•˜ë©´ 2ì˜ ë¬´ê²Œê°€ ë¨ 
                
                â†’ 4ì—ì„œ 50ì„ ë”í•˜ë©´ 2ì˜ ë¬´ê²Œê°€ ë¨ 
                
            - parent[4] = 2
        - ? 4 1
            - find(4) = 2 = find(1)
            - 4ì— 50ì„ ë”í•˜ë©´ 2ê°€ ë˜ê³ , 1ì— 100ì„ ë”í•˜ë©´ 2ê°€ ëœë‹¤
            - weight[4] = 50
            - weight[1] = 100
            - ë‘˜ ì‚¬ì´ì˜ ì°¨ëŠ” -50
    
    ```python
    from collections import defaultdict
    
    def find(a):
        if not parent[a]:
            return a
        pa = parent[a]
        parent[a] = find(pa)
        weight[a] += weight[pa]
        return parent[a]
    
    def union(a, b, w):
        pa = find(a)
        pb = find(b)
        # ë¶€ëª¨ê°€ ì—†ìœ¼ë©´ - union ëœì  í•œë²ˆë„ ì—†ìœ¼ë©´- ìê¸° ìì‹ ìœ¼ë¡œ ë‚˜ì˜´ 
        if pa == pb: # ë¶€ëª¨ê°€ ê°™ìœ¼ë©´ ì´ë¯¸ union ëœ ìƒíƒœë¼ pass
            return
        diff = weight[b] - weight[a] # ì²˜ìŒì—ëŠ” weight ê¸°ë¡ ì—†ìœ¼ë‹ˆê¹Œ 0 
        if rank[pa] > rank[pb]: # ì²˜ìŒì—ëŠ” rankë„ ë‹¤ 0ì´ë¼ ì•„ë˜ ë¶€ë¶„ pass 
            pa, pb = pb, pa 
            w = -w
            diff = -diff
        weight[pa] = w + diff # 0 + w = w
        parent[pa] = pb # union ëœ ì  ì—†ìœ¼ë©´ pa = a, pb = bì´ê³  bì˜ ë¬´ê²Œê°€ ëŠ˜ ë” ë¬´ê²ë‹¤ 
        if rank[pa] == rank[pb]: # ì²˜ìŒì—” rankê°€ ê°™ê¸° ë•Œë¬¸ì— 
            rank[pb] += 1 # pb ìª½ìœ¼ë¡œ í•©ì³¤ìœ¼ë¯€ë¡œ rank ì˜¬ë ¤ì¤€ë‹¤ 
    
    T = int(input())
    for tc in range(1, T + 1):
        N, M = map(int, input().split())
        parent = defaultdict(int)
        weight = defaultdict(int)
        rank = defaultdict(int)
        ans = []
        for _ in range(M):
            work = input()
            if work[0] == '!':
                a, b, w = map(int, work.split()[1:])
                union(a, b, w)
            else:
                a, b = map(int, work.split()[1:])
                if find(a) == find(b):
                    ans.append(weight[a] - weight[b])
                else:
                    ans.append('UNKNOWN')
        print('#{} {}'.format(tc, ' '.join(map(str, ans))))
    ```
    
- [x]  ì²˜ìŒë¶€í„° ëê¹Œì§€ ë‹¤ì‹œ ì§œë³´ê¸°
- [x]  ì•½ì‹ UF ë§ê³  class ì‚¬ìš©í•˜ëŠ” ì •ì‹ UFì— ì ìš©í•´ë³´ê¸°
- í—·ê°ˆë¦¬ëŠ” ì—°ì‚°
    - find í•˜ë©´ weight[x] = root_x - x
    - y - x = w_diff
    - find í•˜ë©´ weight[y] = root_y - y
    - root_yë¥¼ root_xì— ì—°ê²°í•˜ëŠ” ê²ƒì´ë¯€ë¡œ root_yì˜ ê°€ì¤‘ì¹˜ë¥¼ ë°”ê¿”ì•¼ í•¨
        - root_yì™€ y ì‚¬ì´ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ë©´ì„œ
        - self.weight[root_y] = w_diff + (self.weight[x] - self.weight[y])
        - y-x ì°¨ì´: w_diff
        - root_x-x ì°¨ì´: self.weight[x]
        - root_y-y ì°¨ì´: self.weight[y]
        - ì„¸ ê°œë¥¼ ë‹¤ ë”í•˜ë©´ root_x - root_yê°€ ë‚˜ì™€ì•¼ í•¨
        - x-y + root_x-x = root_y + y = root_x - root_y
- ì­‰ í•´ë³´ê¸°
    
    **! 1 2 100**
    
    â†’ root:1, weight[2] = -100
    
    rank[1] += 1 
    
    ? 2 3
    
    â†’ unknown 
    
    **! 2 3 100**
    
    â†’ root_y = find(3) = 3
    
    - root_x = find(2) = 1
        - 2 â‰  1
        
        â†’ weight[2] += weight[1] = -100 
        
    - rank[3] = 0 < rank[1] = 1
        - root[3] = 1
        - weight[root_y] : root_x - root_y
            - root_x - x - root_y + y = root_x - root_y + (y-x)
            - w_diff = y - x
        - weight[3] = -100 + weight[2] - weight[3] = -100 -100 = -200
    
    ? 2 3
    
    â†’ weight[2] - weight[3] = -100 - (-200) = 100 
    
    ? 1 3
    
    â†’ weight[1] = 0 - weight[3] = -200 = 200 
    
    **! 4 3 150**
    
    - find(3)
        - o.g.root = 1
        - find(1)= 1 â†’ root[3]
            - ë§Œì•½ì—ì„œ ì—¬ê¸°ì„œ find(1)ì´ ì•„ë‹ˆë¼ 15 ê°™ì€ ìˆ«ìë¼ê³  í•˜ë©´
            - weight[1] = weight[15]-weight[1]
            - weight[3] = weight[1] - weight[3]
                
                = weight[15]-weight[1] + weight[1] - weight[3]
                
                = weight[o.g.root] + weight[x] 
                
                = weight[15] - weight[3] 
                
            - weight[3] += weight[1]  = -200 + 0 = -200
        - find(4) = 4
    - union(4, 3)
        - rank[root_3] = 1 > rank[root_4] = 0
        - 1ë¡œ í•©ì¹œë‹¤
            - root[4] = 1
            - weight[4] = weight[1] - weight[4]
                - -weight[3] + weight[3] + weight[1] - weight[4]
                
                = (weight[1]-weight[3])-(weight[4]-weight[3]) 
                
                = weight[3] = -200 - (150) = -350 
                
    
    ? 4 1
    
    â†’ ì´ìƒí•˜ë‹¤ í–ˆë”ë‹ˆ union ë¶€ë¶„ì—ì„œ ëˆ„êµ¬ì˜ rootë¥¼ ë°”ê¿”ì•¼ í•˜ëŠ”ì§€ê°€ ì˜ëª»ë˜ì–´ ìˆì—ˆìŒ 
    
- AC ì½”ë“œ (ğŸ‹ï¸â€â™€ï¸ğŸª‡)
    
    ```python
    class UnionFind:
        def __init__(self, size):
            self.size = size + 1
            self.weight = [0] * self.size  # weight difference from its root
            self.root = [i for i in range(self.size)]
            self.rank = [1] * self.size
    
        def find(self, x):
            if self.root[x] != x:
                original_root = self.root[x]  # check
                self.root[x] = self.find(self.root[x])
                self.weight[x] += self.weight[original_root]
            return self.root[x]
    
        def union(self, x, y, w_diff):
            # x is lighter
            root_x, root_y = self.find(x), self.find(y)
            if root_x != root_y:
                if self.rank[root_x] > self.rank[root_y]:  # root: root_x
                    self.root[root_y] = root_x
                    # x - y + root_x - x - root_y + y -> root_x - root_y + (x - y - x + y) = root_x - root_y
                    self.weight[root_y] = -w_diff + self.weight[x] - self.weight[y]
                elif self.rank[root_x] < self.rank[root_y]:  # root: root_y
                    self.root[root_x] = root_y
                    # y - x + root_y - y - root_x + x = root_y - root_x + (y - x - y + x) = root_y - root_x
                    self.weight[root_x] = w_diff + self.weight[y] - self.weight[x]
                else:  # root: root_x
                    self.root[root_y] = root_x
                    self.rank[root_x] += 1
                    self.weight[root_y] = -w_diff + self.weight[x] - self.weight[y]
    
        def is_connected(self, x, y):
            return self.find(x) == self.find(y)
    
    T = int(input())
    for t in range(1, T+1):
        N, M = map(int, input().split())
        UF = UnionFind(N)
        ans = []
        for _ in range(M):
            data = list(input().split())
            if len(data) == 4:
                a, b, w = map(int, data[1:])
                print(UF.root[a], UF.root[b], UF.weight[a], UF.weight[b])
                UF.union(a, b, w)
                print(a, b, w)
                print(UF.root[a], UF.root[b], UF.weight[a], UF.weight[b])
            else:
                a, b = map(int, data[1:])
                if UF.is_connected(a, b): # bê°€ aë³´ë‹¤ ì–¼ë§ˆë‚˜ ë¬´ê±°ìš´ì§€
                    #print(UF.root[a], UF.root[b], UF.weight[a], UF.weight[b])
                    ans.append(str(UF.weight[a]-UF.weight[b]))
                else:
                    ans.append('UNKNOWN')
    
        print(f'#{t} {" ".join(ans)}')
    
    ```